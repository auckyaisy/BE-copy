<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Well Analysis - Results</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    img.plot { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 6px; }
    .table-wrap { max-height: 480px; overflow: auto; }
    .monospace { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="mb-0">Results - {{ well_name }}</h1>
      <a class="btn btn-secondary" href="{{ url_for('index') }}">← New Analysis</a>
    </div>

    <div class="row g-4">

      <div class="col-12">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center bg-light">
            <h5 class="mb-0">Daily Activity</h5>
            <span class="badge bg-secondary">Bar height = records per day, colored by dominant status</span>
          </div>
          <div class="card-body p-2">
            <div id="dailyBar" style="width: 100%; height: 350px;"></div>
          </div>
          <div class="card-footer bg-white border-top pt-2 pb-3">
            <small class="text-muted d-block text-center mb-2">
              <i class="bi bi-info-circle"></i> Hover over bars for details. Color indicates the most common non-Running status for each day.
            </small>
            <div class="legend d-flex flex-wrap justify-content-center gap-2" id="dailyLegend"></div>
          </div>
        </div>
      </div>

      {% if summary_text %}
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <strong>Summary & Recommendations</strong>
          </div>
          <div class="card-body">
            <pre class="mb-0" style="white-space: pre-wrap;">{{ summary_text }}</pre>
          </div>
        </div>
      </div>
      {% endif %}

      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <strong>Dominant Status Distribution</strong>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <h6>All statuses</h6>
                {% if pie_all_b64 %}
                  <img class="plot" src="{{ pie_all_b64 }}" alt="Dominant status distribution (all)">
                {% else %}
                  <div class="alert alert-info mb-0">No data to render pie chart.</div>
                {% endif %}
              </div>
              <div class="col-md-6">
                <h6>Non-Running only</h6>
                {% if pie_nonrun_b64 %}
                  <img class="plot" src="{{ pie_nonrun_b64 }}" alt="Dominant status distribution (non-running)">
                {% else %}
                  <div class="alert alert-info mb-0">No non-Running windows detected.</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <strong>30-minute Window Slopes</strong>
          </div>
          <div class="card-body">
            <p class="text-muted mb-2">Slopes for A, IP, DP, IT, MT, V, R (unit: per-second slope from linear fit within each 30-minute window).</p>
            <img class="plot" src="{{ slope_plot }}" alt="Slope plot">
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <strong>Virtual Rate (Predicted)</strong>
          </div>
          <div class="card-body">
            <img class="plot" src="{{ rate_plot }}" alt="Virtual rate plot">
          </div>
        </div>
      </div>

      


      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Failure Prediction Table</strong>
            {% if pred_csv_path %}
              <span class="text-muted monospace small">Saved CSV: {{ pred_csv_path }}</span>
            {% endif %}
          </div>
          <div class="card-body">
            {% if table_preview and table_columns %}
              <div class="table-wrap">
                <table class="table table-sm table-striped table-hover">
                  <thead class="table-light">
                    <tr>
                      {% for col in table_columns %}
                        <th>{{ col }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in table_preview %}
                      <tr class="{% if row['Status'] and row['Status'] != 'Running' %}table-warning{% endif %}">
                        {% for col in table_columns %}
                          <td>{{ row[col] }}</td>
                        {% endfor %}
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <p class="text-muted small">Showing up to 500 rows. Full file saved to <code>{{ pred_csv_path }}</code>.</p>
            {% else %}
              <div class="alert alert-info mb-0">No prediction rows to display.</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Detected Events (3-hour Dominant Status)</strong>
            <span class="text-muted small">Non-"Running" groups are highlighted.</span>
          </div>
          <div class="card-body">
            {% if detected_events %}
              <div class="d-flex flex-wrap gap-2 mb-3">
                {% for ev in detected_events %}
                  <span class="badge text-bg-danger">
                    {{ ev['date'] }} {{ ev['group_start'].split(' ')[1] }}–{{ ev['group_end'].split(' ')[1] }}: {{ ev['dominant_status'] }}
                  </span>
                {% endfor %}
              </div>
            {% else %}
              <div class="alert alert-success">No non-Running dominant events detected under the 3-hour grouping rule.</div>
            {% endif %}

            {% if group_summaries %}
              <div class="table-wrap">
                <table class="table table-sm table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Date</th>
                      <th>Group Start</th>
                      <th>Group End</th>
                      <th>Non-Running Count</th>
                      <th>Dominant Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for g in group_summaries %}
                      <tr class="{% if g['dominant_status'] != 'Running' %}table-warning{% endif %}">
                        <td>{{ g['date'] }}</td>
                        <td>{{ g['group_start'] }}</td>
                        <td>{{ g['group_end'] }}</td>
                        <td>{{ g['non_running_count'] }}</td>
                        <td>{{ g['dominant_status'] }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  <script id="dailyPayload" type="application/json">{{ daily_bar_data | tojson | safe }}</script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script>
    (function(){
      console.log('Initializing chart rendering...');
      try {
        const dailyPayload = (function(){
          try { return JSON.parse(document.getElementById('dailyPayload')?.textContent || '{}'); }
          catch(_) { return {}; }
        })() || { dates: [], counts: [], statuses: [] };

        console.log('Daily bar data:', dailyPayload);

        if (!Array.isArray(dailyPayload.dates)) dailyPayload.dates = [];
        if (!Array.isArray(dailyPayload.counts)) dailyPayload.counts = [];
        if (!Array.isArray(dailyPayload.statuses)) dailyPayload.statuses = [];

        const colorMap = {
          'Running': '#9aa0a6',
          'Low PI': '#2ca02c',
          'Pump Wear': '#8c564b',
          'Tubing Leak': '#17becf',
          'Higher PI': '#1f77b4',
          'Increase in Frequency': '#bcbd22',
          'Open Choke': '#7f7f7f',
          'Increase in Watercut': '#9467bd',
          'Sand Ingestion': '#e377c2',
          'Closed Valve': '#2a3f5f',
          'Electrical Downhole Problem': '#ff7f0e',
          'Shut-in': '#E45756',
          '100% Watercut': '#581845',
          'Unidentified': '#6c757d'
        };

        console.log('Rendering daily bar chart with', dailyPayload.dates ? dailyPayload.dates.length : 0, 'days');
        const dailyBarEl = document.getElementById('dailyBar');

        try {
          console.log('Daily payload structure:', {
            hasDates: !!dailyPayload.dates,
            datesLength: dailyPayload.dates ? dailyPayload.dates.length : 0,
            countsLength: dailyPayload.counts ? dailyPayload.counts.length : 0,
            statusesLength: dailyPayload.statuses ? dailyPayload.statuses.length : 0,
            sampleData: {
              dates: dailyPayload.dates ? dailyPayload.dates.slice(0, 3) : [],
              counts: dailyPayload.counts ? dailyPayload.counts.slice(0, 3) : [],
              statuses: dailyPayload.statuses ? dailyPayload.statuses.slice(0, 3) : []
            }
          });

          if (dailyPayload && dailyPayload.dates && dailyPayload.dates.length > 0) {
            const validCounts = dailyPayload.counts && dailyPayload.counts.length === dailyPayload.dates.length
              ? dailyPayload.counts
              : new Array(dailyPayload.dates.length).fill(0);

            const validStatuses = dailyPayload.statuses && dailyPayload.statuses.length === dailyPayload.dates.length
              ? dailyPayload.statuses
              : new Array(dailyPayload.dates.length).fill('Unknown');

            const trace = {
              type: 'bar',
              x: dailyPayload.dates,
              y: validCounts,
              marker: {
                color: validStatuses.map(s => colorMap[s] || '#6c757d'),
                line: { width: 0.5, color: 'white' }
              },
              hoverinfo: 'text',
              hovertext: dailyPayload.dates.map((date, i) => 
                `Date: ${date}<br>Records: ${validCounts[i]}<br>Status: ${validStatuses[i] || 'Unknown'}` 
              ),
              hoverlabel: {
                bgcolor: 'white',
                font: { color: 'black' },
                bordercolor: '#ddd'
              }
            };

            const layoutDaily = {
              margin: {l: 50, r: 20, t: 10, b: 80},
              xaxis: {
                type: 'category',
                showgrid: false,
                tickangle: -45,
                tickfont: { size: 10 },
                automargin: true
              },
              yaxis: {
                title: 'Records per day',
                showgrid: true,
                gridcolor: '#f5f5f5',
                zeroline: false,
                fixedrange: true
              },
              plot_bgcolor: 'white',
              paper_bgcolor: 'white',
              bargap: 0.2,
              hovermode: 'closest'
            };

            const config = {
              displayModeBar: true,
              responsive: true,
              staticPlot: false
            };

            dailyBarEl.innerHTML = '';
            Plotly.newPlot(dailyBarEl, [trace], layoutDaily, config)
              .then(() => {
                console.log('Daily bar chart rendered successfully');
                // Build legend
                try {
                  const legendEl = document.getElementById('dailyLegend');
                  if (!legendEl) return;
                  const uniqueStatuses = Array.from(new Set(validStatuses));
                  legendEl.innerHTML = uniqueStatuses.map(s => {
                    const col = colorMap[s] || '#6c757d';
                    return `<span class="badge me-2 mb-2" style="background-color:${col}">${s}</span>`;
                  }).join('');
                } catch (e) { console.warn('Legend build failed', e); }
              })
              .catch(err => {
                console.error('Error rendering daily bar chart:', err);
                dailyBarEl.innerHTML = `
                  <div class="alert alert-warning">
                    <h5>Error rendering daily activity chart</h5>
                    <p>${err.message || 'Unknown error occurred'}</p>
                    <p class="small">Check console for more details.</p>
                  </div>`;
              });
          } else {
            dailyBarEl.innerHTML = `
              <div class="alert alert-info text-center py-4">
                <h5>No daily data available</h5>
                <p class="mb-0">The daily activity data could not be loaded or is empty.</p>
              </div>`;
            console.warn('No daily data available to render');
          }
        } catch (e) {
          console.error('Error in daily chart rendering:', e);
          dailyBarEl.innerHTML = `
            <div class="alert alert-danger">
              <h5>Error loading daily chart</h5>
              <p>${e.message || 'An unexpected error occurred'}</p>
              <p class="small">${e.stack || ''}</p>
            </div>`;
        }
      } catch (e) {
        console.error('Error in chart initialization:', e);
        const firstChart = document.querySelector('#dailyBar');
        if (firstChart) {
          firstChart.innerHTML = `<div class="alert alert-danger">Error loading chart data: ${e.message}</div>`;
        }
      }
    })();
  </script>
</body>
</html>
